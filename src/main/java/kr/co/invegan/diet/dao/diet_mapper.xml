<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="kr.co.invegan.diet.dao.DietDAO">

	<select id="findFoodList" parameterType="String" resultType="kr.co.invegan.diet.dto.FoodDataDTO">
		SELECT * FROM FoodData 
			WHERE food_name LIKE CONCAT('%', #{param1},'%')
			ORDER BY CASE 
				WHEN food_name LIKE #{param1} THEN 1
				WHEN food_name LIKE CONCAT(#{param1}, ',%') THEN 2
	 			WHEN food_name LIKE CONCAT(#{param1}, '%') THEN 3
				WHEN food_name LIKE CONCAT('%',#{param1}, '%') THEN 4
				WHEN food_name LIKE CONCAT('%', #{param1}) THEN 5
			ELSE 0 END;
	</select>
	
	<select id="showNutri" parameterType="int" resultType="kr.co.invegan.diet.dto.FoodDataDTO">
		SELECT * FROM FoodData 
			WHERE food_id = #{param1};
	</select>
	
	<select id="getServingSize" parameterType="int" resultType="int">
		SELECT serving_size FROM FoodData WHERE food_id = #{food_id};
	</select>
	
	
	
	<insert 
		useGeneratedKeys="true"
		keyColumn="diet_id"
		keyProperty="diet_id"
		id="addDiet" parameterType="kr.co.invegan.diet.dto.DietDTO">
		INSERT INTO Diet(user_no,date,diet_category) 
			VALUES(
				(SELECT user_no FROM Members WHERE id=#{user_no})
				, #{date}, #{diet_category});
	</insert>
	
	<insert
		useGeneratedKeys="true"
		keyColumn="menu_id"
		keyProperty="menu_id" 
		id="addMenu" parameterType="kr.co.invegan.diet.dto.DietDTO">
		INSERT INTO Menu(user_no,recipe_name,category)
			VALUES(
				(SELECT user_no FROM Members WHERE id=#{user_no})
				,#{recipe_name},#{category});
	</insert>
	
 	<insert id="addMaterial" parameterType="hashmap">
		INSERT INTO Material(food_id,grams,menu_id)
			VALUES(#{food_id}, #{grams}, #{menu_id});
	</insert>
	
	<insert id="addDietComp" parameterType="hashmap">
		INSERT INTO Diet_composition(diet_id,menu_id)
			VALUES(#{diet_id},#{menu_id});
	</insert>
	
	
	
	<select id="getDietList" parameterType="hashmap" resultType="kr.co.invegan.diet.dto.DietDTO">
		SELECT d.date, d.diet_id, d.diet_category, m.menu_id, m.recipe_name, m.category ,fd.food_id ,fd.food_name, 
			mt.grams, ROUND((fd.kcal * mt.grams / fd.serving_size),2)AS kcal
		FROM Diet d
			INNER JOIN Diet_composition dc ON d.diet_id = dc.diet_id
			INNER JOIN Menu m ON dc.menu_id = m.menu_id
			INNER JOIN Material mt ON m.menu_id = mt.menu_id
			INNER JOIN FoodData fd ON mt.food_id = fd.food_id
		WHERE d.user_no = #{loginId} AND d.date = #{date};
	</select>
	
	
	
	
	
	
	
</mapper>